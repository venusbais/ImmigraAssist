{% extends "attorney_base.html" %}

{% block title %}Calendar - Attorney Corner{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
{% endblock %}

{% block attorney_content %}
<div class="card">
    <div class="card-header">
        <h2>Calendar</h2>
        <button class="btn btn-primary" data-toggle="modal" data-target="#addEventModal">
            <i class="fas fa-plus"></i> Add Event
        </button>
    </div>
    <div class="card-body">
        <div class="calendar-container">
            <div class="calendar-sidebar">
                <div class="sidebar-section">
                    <h4>Event Types</h4>
                    <div class="event-type-filters">
                        <label class="event-type-label">
                            <input type="checkbox" class="event-type-checkbox" value="appointment" checked>
                            <span class="event-type-marker" style="background-color: #4299e1;"></span>
                            <span>Appointments</span>
                        </label>
                        <label class="event-type-label">
                            <input type="checkbox" class="event-type-checkbox" value="deadline" checked>
                            <span class="event-type-marker" style="background-color: #f56565;"></span>
                            <span>Filing Deadlines</span>
                        </label>
                        <label class="event-type-label">
                            <input type="checkbox" class="event-type-checkbox" value="court" checked>
                            <span class="event-type-marker" style="background-color: #805ad5;"></span>
                            <span>Court Dates</span>
                        </label>
                        <label class="event-type-label">
                            <input type="checkbox" class="event-type-checkbox" value="consultation" checked>
                            <span class="event-type-marker" style="background-color: #38a169;"></span>
                            <span>Consultations</span>
                        </label>
                        <label class="event-type-label">
                            <input type="checkbox" class="event-type-checkbox" value="reminder" checked>
                            <span class="event-type-marker" style="background-color: #ecc94b;"></span>
                            <span>Reminders</span>
                        </label>
                        <label class="event-type-label">
                            <input type="checkbox" class="event-type-checkbox" value="other" checked>
                            <span class="event-type-marker" style="background-color: #a0aec0;"></span>
                            <span>Other</span>
                        </label>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h4>Upcoming Events</h4>
                    <div class="upcoming-events">
                        {% if upcoming_events %}
                            {% for event in upcoming_events %}
                            <div class="upcoming-event">
                                <div class="event-date">
                                    <span class="event-month">{{ event.start_time.strftime('%b') }}</span>
                                    <span class="event-day">{{ event.start_time.strftime('%d') }}</span>
                                </div>
                                <div class="event-details">
                                    <div class="event-title">{{ event.title }}</div>
                                    <div class="event-time">{{ event.start_time.strftime('%I:%M %p') }} - {{ event.end_time.strftime('%I:%M %p') }}</div>
                                    {% if event.client_name %}
                                    <div class="event-client">{{ event.client_name }}</div>
                                    {% endif %}
                                </div>
                                <span class="event-type-indicator" data-color="{{ event.color }}"></span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-events">No upcoming events</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal" id="addEventModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Event</h3>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-event-form" method="post" action="{{ url_for('add_calendar_event') }}">
                    <div class="form-group">
                        <label for="event-title">Event Title</label>
                        <input type="text" id="event-title" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="event-type">Event Type</label>
                        <select id="event-type" name="event_type" class="form-control" required>
                            <option value="appointment">Appointment</option>
                            <option value="deadline">Filing Deadline</option>
                            <option value="court">Court Date</option>
                            <option value="consultation">Consultation</option>
                            <option value="reminder">Reminder</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="event-start-date">Start Date</label>
                            <input type="date" id="event-start-date" name="start_date" class="form-control" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="event-start-time">Start Time</label>
                            <input type="time" id="event-start-time" name="start_time" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="event-end-date">End Date</label>
                            <input type="date" id="event-end-date" name="end_date" class="form-control" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="event-end-time">End Time</label>
                            <input type="time" id="event-end-time" name="end_time" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="event-client">Associated Client (Optional)</label>
                        <select id="event-client" name="client_id" class="form-control">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.firstname }} {{ client.lastname }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event-case">Associated Case (Optional)</label>
                        <select id="event-case" name="case_id" class="form-control">
                            <option value="">-- Select Case --</option>
                            <!-- Cases will be populated via JavaScript based on selected client -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event-location">Location</label>
                        <input type="text" id="event-location" name="location" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea id="event-description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="event-reminder">Reminder</label>
                        <select id="event-reminder" name="reminder" class="form-control">
                            <option value="">No reminder</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                            <option value="60">1 hour before</option>
                            <option value="1440">1 day before</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button form="add-event-form" type="submit" class="btn btn-primary">Save Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal" id="eventDetailsModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="event-details-title">Event Details</h3>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="event-details-content">
                    <div class="detail-section">
                        <div class="detail-item">
                            <span class="detail-label">Date:</span>
                            <span id="event-details-date" class="detail-value"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Time:</span>
                            <span id="event-details-time" class="detail-value"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Type:</span>
                            <span id="event-details-type" class="detail-value"></span>
                        </div>
                        <div id="event-details-location-container" class="detail-item">
                            <span class="detail-label">Location:</span>
                            <span id="event-details-location" class="detail-value"></span>
                        </div>
                    </div>
                    
                    <div id="event-details-client-container" class="detail-section">
                        <h5>Client Information</h5>
                        <div class="detail-item">
                            <span class="detail-label">Client:</span>
                            <span id="event-details-client" class="detail-value"></span>
                        </div>
                        <div id="event-details-case-container" class="detail-item">
                            <span class="detail-label">Case:</span>
                            <span id="event-details-case" class="detail-value"></span>
                        </div>
                    </div>
                    
                    <div id="event-details-description-container" class="detail-section">
                        <h5>Description</h5>
                        <div id="event-details-description" class="description-box"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="edit-event-btn" class="btn btn-primary">Edit</button>
                <button id="delete-event-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply colors to event indicators from data attributes
    document.querySelectorAll('.event-type-indicator').forEach(function(indicator) {
        const color = indicator.getAttribute('data-color');
        if (color) {
            indicator.style.backgroundColor = color;
        }
    });
    
    // Initialize FullCalendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: JSON.parse('{{ calendar_events|tojson }}'),
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        dateClick: function(info) {
            showAddEventModal(info.dateStr);
        },
        eventTimeFormat: {
            hour: 'numeric',
            minute: '2-digit',
            meridiem: 'short'
        }
    });
    
    calendar.render();
    
    // Event type filtering
    const eventTypeCheckboxes = document.querySelectorAll('.event-type-checkbox');
    eventTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            filterEvents();
        });
    });
    
    function filterEvents() {
        const selectedTypes = Array.from(eventTypeCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);
            
        calendar.getEvents().forEach(event => {
            if (selectedTypes.includes(event.extendedProps.eventType)) {
                event.setProp('display', 'auto');
            } else {
                event.setProp('display', 'none');
            }
        });
    }
    
    // Show event details modal
    function showEventDetails(event) {
        document.getElementById('event-details-title').textContent = event.title;
        
        // Format date based on whether it's a full-day event
        let dateStr;
        if (event.allDay) {
            dateStr = new Date(event.start).toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        } else {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            
            if (startDate.toDateString() === endDate.toDateString()) {
                dateStr = startDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
            } else {
                dateStr = `${startDate.toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric'
                })} - ${endDate.toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                })}`;
            }
        }
        
        document.getElementById('event-details-date').textContent = dateStr;
        
        // Time display
        if (event.allDay) {
            document.getElementById('event-details-time').textContent = 'All day';
        } else {
            const startTime = new Date(event.start).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
            const endTime = new Date(event.end).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
            document.getElementById('event-details-time').textContent = `${startTime} - ${endTime}`;
        }
        
        // Event type with capitalization
        const eventType = event.extendedProps.eventType;
        document.getElementById('event-details-type').textContent = 
            eventType.charAt(0).toUpperCase() + eventType.slice(1);
        
        // Location
        const locationContainer = document.getElementById('event-details-location-container');
        if (event.extendedProps.location) {
            locationContainer.style.display = '';
            document.getElementById('event-details-location').textContent = event.extendedProps.location;
        } else {
            locationContainer.style.display = 'none';
        }
        
        // Client and case information
        const clientContainer = document.getElementById('event-details-client-container');
        const caseContainer = document.getElementById('event-details-case-container');
        
        if (event.extendedProps.clientName) {
            clientContainer.style.display = '';
            document.getElementById('event-details-client').textContent = event.extendedProps.clientName;
            
            if (event.extendedProps.caseId) {
                caseContainer.style.display = '';
                document.getElementById('event-details-case').innerHTML = 
                    `<a href="/attorney/petition/${event.extendedProps.caseId}">#${event.extendedProps.caseId}</a>`;
            } else {
                caseContainer.style.display = 'none';
            }
        } else {
            clientContainer.style.display = 'none';
        }
        
        // Description
        const descriptionContainer = document.getElementById('event-details-description-container');
        if (event.extendedProps.description) {
            descriptionContainer.style.display = '';
            document.getElementById('event-details-description').textContent = event.extendedProps.description;
        } else {
            descriptionContainer.style.display = 'none';
        }
        
        // Set up action buttons with event ID
        document.getElementById('edit-event-btn').setAttribute('data-event-id', event.id);
        document.getElementById('delete-event-btn').setAttribute('data-event-id', event.id);
        
        // Show the modal
        const modal = document.getElementById('eventDetailsModal');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');
    }
    
    // Show add event modal with date pre-filled
    function showAddEventModal(dateStr) {
        document.getElementById('event-start-date').value = dateStr;
        document.getElementById('event-end-date').value = dateStr;
        
        const modal = document.getElementById('addEventModal');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');
    }
    
    // Event handlers for edit and delete
    document.getElementById('edit-event-btn').addEventListener('click', function() {
        const eventId = this.getAttribute('data-event-id');
        window.location.href = `/attorney/edit-event/${eventId}`;
    });
    
    document.getElementById('delete-event-btn').addEventListener('click', function() {
        const eventId = this.getAttribute('data-event-id');
        
        if (confirm('Are you sure you want to delete this event?')) {
            fetch(`/attorney/delete-event/${eventId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from calendar and close modal
                    const event = calendar.getEventById(eventId);
                    if (event) {
                        event.remove();
                    }
                    
                    document.getElementById('eventDetailsModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Refresh page to update upcoming events sidebar
                    window.location.reload();
                } else {
                    alert('Failed to delete event: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the event');
            });
        }
    });
    
    // Client change populates cases dropdown
    const clientSelect = document.getElementById('event-client');
    const caseSelect = document.getElementById('event-case');
    
    if (clientSelect && caseSelect) {
        clientSelect.addEventListener('change', function() {
            const clientId = this.value;
            
            // Clear current options
            caseSelect.innerHTML = '<option value="">-- Select Case --</option>';
            
            if (clientId) {
                // Fetch cases for this client
                fetch(`/attorney/get-client-cases/${clientId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.cases) {
                            data.cases.forEach(caseItem => {
                                const option = document.createElement('option');
                                option.value = caseItem.id;
                                option.textContent = `#${caseItem.id} - ${caseItem.visa_type}`;
                                caseSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching cases:', error);
                    });
            }
        });
    }
    
    // Date synchronization
    const startDateInput = document.getElementById('event-start-date');
    const endDateInput = document.getElementById('event-end-date');
    
    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() {
            // Ensure end date is not before start date
            if (endDateInput.value < startDateInput.value) {
                endDateInput.value = startDateInput.value;
            }
        });
    }
    
    // Modal functionality
    const modals = document.querySelectorAll('.modal');
    const closeButtons = document.querySelectorAll('.modal .close, .modal .btn-secondary[data-dismiss="modal"]');
    const modalToggles = document.querySelectorAll('[data-toggle="modal"]');
    
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }
    }
    
    function closeModal(modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    modalToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const targetModal = this.getAttribute('data-target').substring(1);
            openModal(targetModal);
        });
    });
    
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            closeModal(modal);
        });
    });
    
    window.addEventListener('click', function(e) {
        modals.forEach(modal => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });
});
</script>
{% endblock %}
